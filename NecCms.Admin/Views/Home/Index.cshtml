<div class="row mb-5">
    <div class="col-md-12">
                <button class="btn btn-primary" onclick="yenile(0,1)">Bugün</button>
                <button class="btn btn-primary" onclick="yenile(-1,0)">Dün</button>
                <button class="btn btn-primary" onclick="yenile(0,7,true)">Bu Hafta</button>
                <button class="btn btn-primary" onclick="yenile(-7,0,true)">Geçen Hafta</button>
                <button class="btn btn-primary" onclick="yenile(0,30)">Bu Ay</button>
                <button class="btn btn-primary" onclick="yenile(-30,0)">Geçen Ay</button>
                <button class="btn btn-primary" onclick="yenile(0,365)">Bu Yıl</button>
    </div>
</div>
<div class="row">
    <div class="col-xl-5">
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase font-size-12 text-muted mb-3">Görüntülenme Sayısı</h6>
                                <span class="h3 mb-0" id="goruntulenme"> </span>
                            </div>
                        </div> <!-- end row -->

                        <div id="sparkline1" class="mt-3"></div>
                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div> <!-- end col-->

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase font-size-12 text-muted mb-3">Kullanıcı Sayısı</h6>
                                <span class="h3 mb-0" id="kullanici"> </span>
                            </div>
                        </div> <!-- end row -->

                        <div id="sparkline2" class="mt-3"></div>
                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div> <!-- end col-->

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase font-size-12 text-muted mb-3">İçerik</h6>
                                <span class="h3 mb-0" id="icerik"> </span>
                            </div>
                        </div> <!-- end row -->

                        <div id="sparkline3" class="mt-3"></div>
                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div> <!-- end col-->

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase font-size-12 text-muted mb-3">İletişim</h6>
                                <span class="h3 mb-0" id="iletisim"> </span>
                            </div>
                        </div> <!-- end row -->

                        <div id="sparkline4" class="mt-3"></div>
                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div> <!-- end col-->
        </div>
        <!-- end row-->
    </div> <!-- end col -->

    <div class="col-xl-7">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Görüntüleme ve Kullanıcı Sayısı</h4>
                <p class="card-subtitle mb-4">Görüntüleme: Siteye gelen istek sayısı, Kullanıcı: Her bir farklı ip adresidir.</p>

                <div id="morris-bar-example" class="morris-chart" style="height: 304px;"></div>

            </div>
        </div>
    </div> <!-- end col-->

</div> <!-- end row-->

<div class="row">
    <div class="col-xl-3">
        <div class="card m-b-20">
            <div class="card-body">
                <h4 class="card-title" id="menuisim_0"></h4>

                <div class="text-center">
                    <input data-plugin="knob" data-width="120" data-height="120" data-linecap="round"
                           data-fgColor="#31cb72" value="0" data-skin="tron" data-angleOffset="180"
                           data-readOnly="true" data-thickness=".1" id="menuvalue_0"/>

                    <div class="clearfix"></div>
                    <a href="#" class="btn btn-sm btn-light mt-2" id="menuvaluetext_0"></a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card m-b-20">
            <div class="card-body">
                <h4 class="card-title" id="menuisim_1"></h4>

                <div class="text-center">
                    <input data-plugin="knob" data-width="120" data-height="120" data-linecap="round"
                           data-fgColor="#ff5b5b" value="0" data-skin="tron" data-angleOffset="180"
                           data-readOnly="true" data-thickness=".1" id="menuvalue_1"/>

                    <div class="clearfix"></div>
                    <a href="#" class="btn btn-sm btn-light mt-2" id="menuvaluetext_1"></a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card m-b-20">
            <div class="card-body">
                <h4 class="card-title" id="menuisim_2"></h4>

                <div class="text-center">
                    <input data-plugin="knob" data-width="120" data-height="120" data-linecap="round"
                           data-fgColor="#f1c31c" value="0" data-skin="tron" data-angleOffset="180"
                           data-readOnly="true" data-thickness=".1" id="menuvalue_2"/>

                    <div class="clearfix"></div>
                    <a href="#" class="btn btn-sm btn-light mt-2" id="menuvaluetext_2"></a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card m-b-20">
            <div class="card-body">
                <h4 class="card-title" id="menuisim_3"></h4>

                <div class="text-center">
                    <input data-plugin="knob" data-width="120" data-height="120" data-linecap="round"
                           data-fgColor="#19c0ea" value="0" data-skin="tron" data-angleOffset="180"
                           data-readOnly="true" data-thickness=".1" id="menuvalue_3"/>

                    <div class="clearfix"></div>
                    <a href="#" class="btn btn-sm btn-light mt-2" id="menuvaluetext_3"></a>

                </div>
            </div>
        </div>
    </div>

</div>
<!-- end row -->


<div class="row">
<div class="col-xl-6">
    <div class="card">
        <div class="card-body">

            <h4 class="card-title">Son Görüntüleme Bilgileri</h4>
            <p class="card-subtitle mb-4 font-size-13">
                <a style="cursor:pointer;" onclick="istekGoster(10)">Son 10</a>
                <a style="cursor:pointer;" onclick="istekGoster(25)">Son 25</a>
                <a style="cursor:pointer;" onclick="istekGoster(25)">Son 50</a>
                <a style="cursor:pointer;" onclick="istekGoster(100)">Son 100</a>
                                    </p>

            <div class="table-responsive" id="istekdiv" style="overflow: hidden;">
                <table class="table table-centered table-striped table-nowrap">
                    <thead>
                    <tr>
                        <th>No</th>
                        <th>Tarih</th>
                        <th>Adres</th>
                        <th>Sayfa</th>
                        <th>Query</th>
                        <th>Süresi(ms)</th>
                        <th>Cihaz</th>
                    </tr>
                    </thead>
                    <tbody id="istekler">

                    </tbody>
                </table>
            </div>

        </div> <!-- end card-body-->
    </div> <!-- end card-->
</div> <!-- end col -->

<div class="col-xl-6">
    <div class="card">
        <div class="card-body">

            <h4 class="card-title">Geriye Kalan Kategori Görüntülenme Sayıları</h4>
            <p class="card-subtitle mb-4 font-size-13">Her bir sayfa yenilemesi şeklinde düşünebilirsiniz</p>

            <div class="table-responsive">
                <table class="table table-borderless table-hover table-centered table-nowrap mb-0">
                    <tbody>
                    <tr>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_4"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_4"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_4"></span>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_5"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_5"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_5"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_6"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_6"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_6"></span>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_7"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_7"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_7"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_8"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_8"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_8"></span>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal" id="menuisim_9"></h5>
                        </td>
                        <td>
                            <h5 class="font-size-15 mb-1 font-weight-normal"  id="menuvalue_9"></h5>
                            <span class="text-muted font-size-12" id="menuvaluetext_9"></span>
                        </td>
                    </tr>


                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

</div>


@section Scripts
{
    <script src="~/assets/plugins/charts/jquery.sparkline.min.js"></script>
    <script src="~/assets/plugins/charts/jquery.knob.min.js"></script>
    <script src="~/assets/plugins/charts/morris.min.js"></script>
    <script src="~/assets/plugins/charts/raphael.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@0/dist/ua-parser.min.js"></script>
    <script>
    $('.pageHeader').text('Anasayfa');
    $('.parentHeader').text('Raporlar');

    Date.prototype.addDays = function(days) {
        let date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
    };
    function getMonday(d) {
      d = new Date(d);
      let day = d.getDay(),
          diff = d.getDate() - day + (day === 0 ? -6:1); // adjust when day is sunday
      return new Date(d.setDate(diff));
    }
    
        let baslangic=getMonday(new Date());
        let baslangicStr = baslangic.toISOString().substring(0,10);
        let bitis=baslangic.addDays(7);
        let bitisStr = bitis.toISOString().substring(0,10);
        
        yenile=(start,end,ismonday)=>{
            var date = new Date();
            date.addDays(start);
            if(ismonday)
                baslangic=getMonday(date);
            else
                baslangic=date;

            baslangicStr = baslangic.toISOString().substring(0,10);
            bitis=baslangic.addDays(end);
            bitisStr = bitis.toISOString().substring(0,10);
            init();
        };
        
        $(()=>{
            init();
        });
    
        init=()=>{
                        IstekKullaniciSayisi();
                        ToplamIcerikIletisimSayisi();
                        menuSayilari();
                        istekler();
        };
        IstekKullaniciSayisi=()=>{
            fetch('/Home/IstekKullaniciSayisi?baslangic='+baslangicStr+'&bitis='+bitisStr)
            .then(res=>res.json())
            .then(data=>{
            $("#morris-bar-example").empty(); 
             Morris.Bar({
                element: "morris-bar-example",
                barColors: ["#ebeef1", "#00c2b2"],
                data,
                xkey: "y",
                ykeys: ["a", "b"],
                hideHover: "auto",
                gridLineColor: "#eef0f2",
                resize: !0,
                barSizeRatio: .4,
                labels: ["Görüntüleme Sayısı", "Kullanıcı Sayısı"]
            });
            $('#goruntulenme').text(data.map(x=>x.a).reduce((a,b) => a + b, 0));
            $("#sparkline1").sparkline(data.map(x=>x.a), {
                                                    type: "line",
                                                    width: "100%",
                                                    height: "80",
                                                    chartRangeMax: 35,
                                                    lineColor: "#3f87fd",
                                                    fillColor: "rgba(46, 124, 228, 0.3)",
                                                    highlightLineColor: "rgba(0,0,0,.1)",
                                                    highlightSpotColor: "rgba(0,0,0,.2)",
                                                    maxSpotColor: !1,
                                                    minSpotColor: !1,
                                                    spotColor: !1,
                                                    lineWidth: 1
                                                });
            
            $('#kullanici').text(data.map(x=>x.b).reduce((a,b) => a + b, 0));
            $("#sparkline2").sparkline(data.map(x=>x.b), {
                                                    type: "line",
                                                    width: "100%",
                                                    height: "80",
                                                    chartRangeMax: 35,
                                                    lineColor: "#f1c31c",
                                                    fillColor: "rgba(241, 195, 28, 0.3)",
                                                    highlightLineColor: "rgba(0,0,0,.1)",
                                                    highlightSpotColor: "rgba(0,0,0,.2)",
                                                    maxSpotColor: !1,
                                                    minSpotColor: !1,
                                                    spotColor: !1,
                                                    lineWidth: 1
                                                })
            });
        };
        ToplamIcerikIletisimSayisi=()=> {
            fetch('/Home/ToplamIcerikIletisimSayisi?baslangic='+baslangicStr+'&bitis='+bitisStr)
                        .then(res=>res.json())
                        .then(data=>{

                        $('#icerik').text(data.map(x=>x.a).reduce((a,b) => a + b, 0));
                        $("#sparkline3").empty().sparkline(data.map(x=>x.a), {
                                            type: "line",
                                            width: "100%",
                                            height: "80",
                                            chartRangeMax: 35,
                                            lineColor: "#ff5b5b",
                                            fillColor: "rgba(255, 91, 91, 0.3)",
                                            highlightLineColor: "rgba(0,0,0,.1)",
                                            highlightSpotColor: "rgba(0,0,0,.2)",
                                            maxSpotColor: !1,
                                            minSpotColor: !1,
                                            spotColor: !1,
                                            lineWidth: 1
                                        }); 
                            
                        $('#iletisim').text(data.map(x=>x.b).reduce((a,b) => a + b, 0));
                        $("#sparkline4").empty().sparkline(data.map(x=>x.b), {
                                            type: "line",
                                            width: "100%",
                                            height: "80",
                                            chartRangeMax: 35,
                                            lineColor: "#1a213b",
                                            fillColor: "rgba(67, 75, 107, 0.3)",
                                            highlightLineColor: "rgba(0,0,0,.1)",
                                            highlightSpotColor: "rgba(0,0,0,.2)",
                                            maxSpotColor: !1,
                                            minSpotColor: !1,
                                            spotColor: !1,
                                            lineWidth: 1
                                        });
                        });
            
            };
            menuSayilari = ()=> {
                fetch('/Home/MenuSayilari?baslangic='+baslangicStr+'&bitis='+bitisStr)
                .then(res=>res.json())
                .then(res=>{
                    let total = res.map(x=>x.a).reduce((a,b)=>a+b,0);
                    $('[data-angleOffset]').attr('data-angleOffset',total)
                    res.map((item,i)=>{
                           $('#menuisim_'+i).text(item.y); 
                           $('#menuvalue_'+i).val(((item.a/total)*100).toFixed(2)).text(((item.a/total)*100).toFixed(2)+'%'); 
                           $('#menuvaluetext_'+i).text(item.a); 
                    });
                   $('[data-plugin="knob"]').knob(); 
                });
            };
            let take =3;
            istekGoster=(istek)=>{
                take=istek;
                $('#istekdiv').css('overflow','auto');
                istekler();
            };
            istekler=()=> {
                let parser = new UAParser();
                fetch('/Home/Istekler?take='+take+'&baslangic='+baslangicStr+'&bitis='+bitisStr)
                .then(res=>res.json())
                .then(res=>{
                    $('#istekler').empty();
                    getCity(res);
                    res.map((item,i)=>{
                            parser.setUA(item.userAgent);
                            let result = parser.getResult();
                            $('#istekler').append('<tr><td>'+item.id+'</td><td>'+formatDateLocate(item.tarih)+' '+item.tarih.substr(11,5)+'</td><td class="ip_'+item.remoteIpAddress.replace(/./g,'_')+'"></td><td>'+item.path+'</td><td>'+(item.queryString||"")+'</td><td>'+item.time+'</td><td>'+(result.browser.name||"")+" / "+((result.device.name||result.os.name)||"")+'</td></tr>') 
                    });
                });
            };
            getCity=(data)=>{
                [...new Set(data.map(item=>item.remoteIpAddress))].map(item=>{
                    fetch('http://ip-api.com/json/'+item)
                                                .then(res2=>res2.json())
                                                .then(res2=>$('.ip_'+item.replace(/./g,'_')).text(res2.city))
                })
            }
        </script>

}